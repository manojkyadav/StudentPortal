<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="content">
	<div th:replace="~{fragments/header :: header}"></div>
	<h2 th:text="${question.id} != null ? 'Edit Question' : 'New Question'">New Question</h2>

	<form th:action="@{/app/questions/save}" th:object="${question}" method="post">
		<input type="hidden" th:field="*{id}" />

		<!-- Class Selection -->
		<div class="mb-3">
			<label>Classroom</label>
			<select class="form-select" name="classRoom.id" onchange="redirectToQuestion(this.value)">
				<option value="">Select Class</option>
				<option th:each="c : ${classroomList}" th:value="${c.id}" th:text="${c.className}"
					th:selected="${selectedClassId} == ${c.id}"></option>
			</select>
		</div>

		<!-- Subject Selection -->
		<div class="mb-3">
			<label>Subject</label>
			<select class="form-select" name="subject.id" onchange="redirectToSubjects(this.value)">
				<option value="">Select Subject</option>
				<option th:each="s : ${subjectList}" th:value="${s.id}" th:text="${s.subjectName}"
					th:selected="${selectedSubjectId} == ${s.id}"></option>
			</select>
		</div>

		<!-- Topic Selection -->
		<div class="mb-3">
			<label>Topic</label>
			<select class="form-select" name="topics.id">
				<option value="">Select Topic</option>
				<option th:each="t : ${topicList}" th:value="${t.id}" th:text="${t.topicName}"
					th:selected="${question.topics != null} ? ${question.topics.id} == ${t.id} : false"></option>
			</select>
		</div>

		<!-- Question Text -->
		<div class="mb-3">
			<label class="form-label">Question Text</label>
			<textarea class="form-control" th:field="*{questionTxt}" rows="3" placeholder="Enter question" required></textarea>
		</div>

		<!-- Difficulty -->
		<div class="mb-3">
			<label class="form-label">Difficulty</label>
			<select class="form-select" th:field="*{difficultyLevel}">
				<option th:value="EASY">EASY</option>
				<option th:value="MEDIUM">MEDIUM</option>
				<option th:value="HARD">HARD</option>
			</select>
		</div>

		<!-- Question Type -->
		<div class="mb-3">
			<label class="form-label">Question Type</label>
			<select class="form-select" th:field="*{questionType}" id="questionType">
				<option th:value="MULTIPLE_CHOICE">Multiple Choice</option>
				<option th:value="TRUE_FALSE">True / False</option>
				<option th:value="SHORT_ANSWER">Short Answer</option>
				<option th:value="FILL_IN_THE_BLANK">Fill in the Blank</option>
				<option th:value="MATCHING">Matching</option>
			</select>
		</div>

		<!-- Multiple Choice Options -->
		<div id="multipleChoiceSection" style="display:none;">
			<label class="form-label">Options</label>
			<div id="optionContainer">
				<div th:each="opt, iterStat : *{options}" class="d-flex mb-2 option-row">
					<input type="text" th:field="*{options[__${iterStat.index}__].optionText}" class="form-control me-2" placeholder="Option text">
					<input type="checkbox" th:field="*{options[__${iterStat.index}__].isCorrect}"> Correct
				</div>
			</div>
			<button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addOption()">+ Add Option</button>
		</div>

		<!-- Explanation -->
		<div class="mb-3">
			<label class="form-label">Explanation</label>
			<textarea class="form-control" th:field="*{explanation}" rows="3"></textarea>
		</div>

		<!-- Status -->
		<div class="mb-3">
			<label>Status</label>
			<select class="form-select" th:field="*{status}">
				<option th:value="ACTIVE">ACTIVE</option>
				<option th:value="INACTIVE">INACTIVE</option>
			</select>
		</div>

		<!-- Submit Buttons -->
		<div class="mb-3">
			<button class="btn btn-primary" type="submit">Save</button>
			<a class="btn btn-secondary" th:href="@{/app/questions}">Cancel</a>
		</div>
	</form>
</div>

<div th:replace="~{layout :: layout(~{::content})}"></div>

<script>
	function redirectToQuestion(classId) {
		if (classId) {
			window.location.href = '/app/questions/new?classId=' + classId;
		} else {
			window.location.href = '/app/questions/new';
		}
	}

	function redirectToSubjects(subjectId) {
		const select = document.querySelector('select[name="classRoom.id"]');
		const classId = select.options[select.selectedIndex].value;
		if (subjectId) {
			window.location.href = '/app/questions/new?subjectId=' + subjectId + '&classId=' + classId;
		} else {
			window.location.href = '/app/questions/new';
		}
	}

	document.addEventListener("DOMContentLoaded", function () {
		const typeSelect = document.getElementById("questionType");
		const mcSection = document.getElementById("multipleChoiceSection");

		function toggleOptionSection() {
			mcSection.style.display = typeSelect.value === "MULTIPLE_CHOICE" ? "block" : "none";
		}

		typeSelect.addEventListener("change", toggleOptionSection);
		toggleOptionSection();
	});

	function addOption() {
		const container = document.getElementById("optionContainer");
		const index = container.children.length;
		const div = document.createElement("div");
		div.className = "d-flex mb-2 option-row";
		div.innerHTML = `
			<input type="text" name="options[${index}].optionText" class="form-control me-2" placeholder="Option text">
			<input type="checkbox" name="options[${index}].isCorrect"> Correct
		`;
		container.appendChild(div);
	}
</script>
</html>
