<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Admin Dashboard</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<script src="https://unpkg.com/feather-icons"></script>

	<style>
		/* Main content */
		.main-content {
			margin-left: 0px;
			padding: 40px;
			font-family: 'Space Grotesk', sans-serif;
			background: #e9edf7;
			min-height: 100vh;
		}

		.main-content h1 {
			font-size: 28px;
			margin-bottom: 10px;
			color: #2c3e50;
		}

		.main-content p {
			color: #7f8c8d;
			margin-bottom: 20px;
		}

		/* Class table */
		.class-table {
			background: #fff;
			border-radius: 15px;
			padding: 20px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
		}

		.class-table .add-btn {
			display: inline-block;
			background: linear-gradient(135deg, #5c6bc0, #7986cb);
			color: #fff;
			padding: 10px 25px;
			border-radius: 10px;
			margin-bottom: 20px;
			text-decoration: none;
			font-weight: 500;
			transition: all 0.3s;
		}
	</style>
</head>

<body>

	<div class="dashboard-layout">

		<!-- Sidebar -->
		<div th:replace="fragments/adminsidebar :: sidebarFragment"></div>
		
		<main class="main-content">
			<div class="main-content">
				<h1>Questions Management</h1>
				<p>Manage Questions for each class</p>

				<div class="class-table">
					<a href="#" class="add-btn">+ Add Question</a>
					<table>
						<thead>
							<tr>
								<th>Class</th>
								<th>Subject</th>
								<th>Topic</th>
								<th>DESCRIPTION</th>
								<th>Question Type</th>
								<th>MEDIUM</th>
								<th>Correct option </th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="q : ${questions}">
								<td th:text="${q.classRoom != null ? q.classRoom.className : '-'}">Class Name</td>
								<td th:text="${q.subject != null ? q.subject.subjectName : '-'}">Subject</td>
								<td th:text="${q.topic != null ? q.topic.topicName : '-'}">Topic</td>
								<td th:text="${#strings.abbreviate(q.questionTxt, 60)}">Question text...</td>
								<td th:text="${q.questionType}">MULTIPLE_CHOICE</td>
								<td th:text="${q.difficultyLevel}">MEDIUM</td>

								<!-- Display correct option(s) if available -->
								<td>
									<ul class="mb-0 ps-3" th:if="${q.options != null}">
										<li th:each="opt : ${q.options}" th:if="${opt.isCorrect}"
											th:text="${opt.text}">Correct option text</li>
									</ul>
								</td>

								<td>
									<div class="btn-group" role="group">
										<a th:href="@{|/app/admin/questions/edit/${q.id}?classId=${q.classRoom.id}&subjectId=${q.subject.id}&topicsId=${q.topic}|}"
											class="btn btn-sm btn-outline-primary">Edit</a>
										<a th:href="@{|/app/admin/questions/delete/${q.id}|}"
											class="btn btn-sm btn-outline-danger"
											onclick="return confirm('Are you sure you want to delete this question?');">Delete</a>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</main>
	</div>

	<div id="addClassModal" class="modal-overlay" style="display: none;">
		<div class="modal-content">
			<div class="modal-header">Add New Question</div>

			<form th:action="@{/app/admin/questions/save}" th:object="${question}" method="post">

				<div class="form-group">
					<label class="form-label">Class</label>
					<select class="form-select" name="classRoom.id" onchange="redirectToSubjects(this.value)">
						<option value="">Select Class</option>
						<option th:each="c : ${classroomList}" th:value="${c.id}" th:text="${c.className}"
							th:selected="${selectedClassId} == ${c.id}"></option>
					</select>
				</div>
				<div class="form-group">
					<label class="form-label">Subject</label>
					<select id="subjectSelect" class="form-select" name="subject.id"
						onchange="redirectToTopic(this.value)">
						<option value="">Select Subject</option>
						<option th:each="s : ${subjectList}" th:value="${s.id}" th:text="${s.subjectName}"
							th:selected="${selectedSubjectId} == ${s.id}"></option>
					</select>
				</div>
				<div class="form-group">
					<label class="form-label">Topic</label>
					<select id="topicSelect" class="form-select" name="topic.id">
						<option value="">Select Topic</option>
						<option th:each="t : ${topicList}" th:value="${t.id}" th:text="${t.topicName}"
							th:selected="${question.topic != null} ? ${question.topic.id} == ${t.id} : false">
						</option>
					</select>
				</div>
				<div class="form-group">
					<label class="form-label">Question Type</label>
					<select class="form-select" th:field="*{questionType}" id="questionType">
						<option th:value="MULTIPLE_CHOICE">Multiple Choice</option>
						<option th:value="TRUE_FALSE">True / False</option>
						<option th:value="SHORT_ANSWER">Short Answer</option>
						<option th:value="FILL_IN_THE_BLANK">Fill in the Blank</option>
						<option th:value="MATCHING">Matching</option>
					</select>
				</div>

				<div class="form-group">
					<label class="form-label">Question Text</label>
					<textarea class="form-textarea" th:field="*{questionTxt}" rows="3"
						placeholder="Enter Question text"></textarea>
				</div>
				<!-- Difficulty -->
				<div class="mb-3">
					<label class="form-label">Difficulty</label>
					<select class="form-select" th:field="*{difficultyLevel}">
						<option th:value="EASY">EASY</option>
						<option th:value="MEDIUM">MEDIUM</option>
						<option th:value="HARD">HARD</option>
					</select>
				</div>
				<!-- MULTIPLE CHOICE SECTION -->
				<div id="multipleChoiceSection" style="display:none;">
					<label class="form-label">Options</label>
				
					<div id="optionContainer">
						<div th:each="opt, iterStat : *{options}" class="d-flex mb-2 option-row">
				
							<input type="text" th:field="*{options[__${iterStat.index}__].text}"
							       class="form-control me-2" placeholder="Option text">
				
							<label class="me-2">
								<input type="checkbox" th:field="*{options[__${iterStat.index}__].correct}"> Correct
							</label>
				
							<button type="button" class="btn btn-danger btn-sm">X</button>
						</div>
					</div>
				
					<button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addOption()">+ Add Option</button>
				</div>

				<!-- Short Answer -->
				<div class="mb-3">
					<label class="form-label">Short Answer </label>
					<textarea class="form-control" th:field="*{answer}" rows="3"></textarea>
				</div>
				<!-- Explanation -->
				<div class="mb-3">
					<label class="form-label">Explanation</label>
					<textarea class="form-control" th:field="*{explanation}" rows="3"></textarea>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
					<button type="submit" class="btn btn-primary">Create</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		feather.replace();

		const modal = document.getElementById("addClassModal");
		const addBtn = document.querySelector(".add-btn");

		addBtn.addEventListener("click", function (e) {
			e.preventDefault();
			modal.style.display = "flex";
		});

		function closeModal() {
			modal.style.display = "none";
		}

		// Close when clicking outside the modal
		window.addEventListener("click", (e) => {
			if (e.target === modal) {
				modal.style.display = "none";
			}
		});

		const typeSelect = document.getElementById("questionType");
		const optionsBox = document.getElementById("optionsContainer");

		// Show/hide MCQ options
		typeSelect.addEventListener("change", () => {
			if (typeSelect.value === "mcq") {
				optionsBox.style.display = "block";
			} else {
				optionsBox.style.display = "none";
			}
		});

		function redirectToTopic(subjectId) {
			const topicSelect = document.getElementById("topicSelect");

			if (!topicSelect) return;

			if (subjectId) {
				fetch('/app/admin/topics/subjectId/' + subjectId)
					.then(res => res.json())
					.then(data => {
						topicSelect.innerHTML = ""; // Clear old subjects

						if (data.length === 0) {
							topicSelect.innerHTML = "<option>No Topic available</option>";
							return;
						}

						data.forEach(sub => {
							const opt = document.createElement("option");
							opt.value = sub.id;
							opt.textContent = sub.topicName;
							topicSelect.appendChild(opt);
						});
					})
					.catch(err => console.error("Error loading Topic:", err));
			} else {
				alert("55");
				topicSelect.innerHTML = "<option value=''>Select Topic</option>";
			}
		}


		function redirectToSubjects(classId) {
			const subjectSelect = document.getElementById("subjectSelect");

			if (!subjectSelect) return;

			if (classId) {
				fetch('/app/admin/subjects/classid/' + classId)
					.then(res => res.json())
					.then(data => {
						subjectSelect.innerHTML = ""; // Clear old subjects

						if (data.length === 0) {
							subjectSelect.innerHTML = "<option>No subjects available</option>";
							return;
						}

						data.forEach(sub => {
							const opt = document.createElement("option");
							opt.value = sub.id;
							opt.textContent = sub.subjectName;
							subjectSelect.appendChild(opt);
						});
					})
					.catch(err => console.error("Error loading subjects:", err));
			} else {
				subjectSelect.innerHTML = "<option value=''>Select subject</option>";
			}
		}


		document.addEventListener("DOMContentLoaded", function () {
			const typeSelect = document.getElementById("questionType");
			const mcSection = document.getElementById("multipleChoiceSection");

			function toggleOptionSection() {
				mcSection.style.display = typeSelect.value === "MULTIPLE_CHOICE" ? "block" : "none";
			}

			typeSelect.addEventListener("change", toggleOptionSection);
			toggleOptionSection();
		});

		function addOption() {
			const container = document.getElementById("optionContainer");
			const index = container.children.length;
			const div = document.createElement("div");
			div.className = "d-flex mb-2 option-row";
			div.innerHTML = `
			    <input type="text" name="options[${index}].text" class="form-control me-2" placeholder="Option text">
			    <input type="checkbox" name="options[${index}].correct"> Correct
			`;

			container.appendChild(div);
		}
		
		function resetIndexes() {
		    const rows = document.querySelectorAll("#optionContainer .option-row");
		    rows.forEach((row, i) => {
		        row.querySelectorAll("input")[0].setAttribute("name", `options[${i}].text`);
		        row.querySelectorAll("input")[1].setAttribute("name", `options[${i}].correct`);
		    });
		}

	</script>

</body>

</html>